# Rimskiy Service

Backend сервис для мобильного приложения управления перекрытыми автомобилями.

## Настройка

1. Скопируйте `.env.example` в `.env`:
```bash
cp .env.example .env
```

2. Отредактируйте `.env` файл и укажите все необходимые параметры:

### Обязательные переменные окружения:

- `DATABASE_URL` - URL подключения к PostgreSQL (например: `postgresql://user:password@localhost/dbname`)
- `JWT_SECRET` - Секретный ключ для JWT токенов (минимум 32 символа)
- `ENCRYPTION_KEY` - Ключ шифрования (должен быть ровно 64 hex символа = 32 байта)

### Опциональные переменные окружения (имеют значения по умолчанию):

- `JWT_EXPIRATION_MINUTES` - Время жизни JWT токена в минутах (по умолчанию: `3`)
- `SERVER_HOST` - IP адрес для прослушивания (по умолчанию: `0.0.0.0`)
- `SERVER_PORT` - Порт сервера (по умолчанию: `8080`)
- `MIGRATIONS_PATH` - Путь к папке с миграциями (по умолчанию: `./migrations`)
- `SMS_CODE_EXPIRATION_MINUTES` - Время жизни SMS кода в минутах (по умолчанию: `10`)
- `SMS_CODE_LENGTH` - Длина SMS кода (по умолчанию: `4`)
- `RETURN_SMS_CODE_IN_RESPONSE` - Возвращать ли SMS код в ответе API (по умолчанию: `true`)
- `APP_APK_PATH` - Путь к APK файлу для скачивания (по умолчанию: `./android/app/build/outputs/apk/release/app-release.apk`)
- `APP_DOWNLOAD_URL` - URL для скачивания приложения (используется в `/server-info`, опционально)
- `MIN_CLIENT_VERSION` - Минимальная обязательная версия клиента (принудительное обновление, формат: `1.0.0`, опционально)
- `RELEASE_CLIENT_VERSION` - Последняя релизная версия клиента (опциональное обновление, формат: `1.1.0`, опционально)

## Генерация ключа шифрования

Для генерации безопасного ключа шифрования (64 hex символа):

```bash
# Linux/Mac
openssl rand -hex 32

# Windows PowerShell
-join ((48..57) + (97..102) | Get-Random -Count 64 | ForEach-Object {[char]$_})
```

## Запуск

1. Убедитесь, что PostgreSQL запущен и база данных создана
2. Запустите миграции (если используете sqlx-cli):
```bash
sqlx migrate run
```

3. Запустите сервер:
```bash
cargo run
```

4. (Опционально) Запустите Telegram бота для авторизации:
```bash
cargo run --bin telegram_bot
```

Для работы бота необходимо указать `TELEGRAM_BOT_TOKEN` в `.env` файле (получить токен можно у [@BotFather](https://t.me/BotFather) в Telegram).

### Настройка Telegram бота как systemd сервиса (для production)

Для запуска Telegram бота как системного сервиса на Linux:

1. Создайте файл `/etc/systemd/system/telegram-bot.service`:
```ini
[Unit]
Description=Telegram Bot for Rimskiy Service
After=network.target

[Service]
Type=simple
User=your-user
WorkingDirectory=/opt/rimskiy-service
ExecStart=/opt/rimskiy-service/telegram_bot
Restart=always
RestartSec=10
Environment="RUST_LOG=info"
EnvironmentFile=-/opt/rimskiy-service/.env

[Install]
WantedBy=multi-user.target
```

2. Замените `your-user` на пользователя, от имени которого будет запускаться бот

3. Убедитесь, что файл `.env` находится в `/opt/rimskiy-service/` и содержит `TELEGRAM_BOT_TOKEN`

4. Активируйте и запустите сервис:
```bash
sudo systemctl daemon-reload
sudo systemctl enable telegram-bot
sudo systemctl start telegram-bot
```

5. Проверьте статус:
```bash
sudo systemctl status telegram-bot
```

6. Просмотр логов:
```bash
sudo journalctl -u telegram-bot -f
```

## Telegram Бот для авторизации

Telegram бот позволяет получать коды авторизации через Telegram и автоматически отправляет SMS на указанный номер телефона.

### Настройка бота

1. Создайте бота через [@BotFather](https://t.me/BotFather) в Telegram
2. Получите токен бота
3. Добавьте токен в `.env` файл:
   ```
   TELEGRAM_BOT_TOKEN=your-telegram-bot-token-here
   ```

### Настройка автоматической отправки SMS (опционально)

Для автоматической отправки SMS кодов на телефон пользователя настройте SMS провайдера:

1. Добавьте в `.env` файл:
   ```
   SMS_API_URL=https://api.sms-provider.com/send
   SMS_API_KEY=your-sms-api-key-here
   ```

2. Адаптируйте метод `send_sms` в `src/auth/sms.rs` под API вашего SMS провайдера

**Примечание**: Если SMS провайдер не настроен, бот будет отправлять коды только в Telegram. Это удобно для разработки и тестирования.

### Команды бота

- `/help` - Показать справку
- `/code <телефон>` - Запросить код авторизации для указанного номера телефона

Пример использования:
```
/code +79001234567
```

Бот автоматически:
1. ✅ Отправит SMS с кодом на указанный номер телефона (если настроен SMS провайдер)
2. ✅ Отправит код в Telegram для удобства
3. ✅ Сообщит о статусе отправки SMS

Код можно использовать в приложении для входа.

## API Документация

### Swagger UI

После запуска сервера доступна интерактивная документация API:

- **Swagger UI**: http://localhost:8080/swagger-ui/
- **OpenAPI JSON**: http://localhost:8080/api-doc/openapi.json

Swagger UI позволяет:
- Просматривать все доступные эндпоинты
- Тестировать API прямо из браузера
- Видеть схемы данных и примеры запросов/ответов
- Авторизоваться через JWT токен

### Основные API Endpoints

#### Аутентификация
- `POST /api/auth/start` - Начало авторизации (получение SMS кода)
- `POST /api/auth/verify` - Подтверждение авторизации (получение JWT токена)
- `POST /api/auth/refresh` - Обновление JWT токена

#### Пользователи
- `GET /api/users/me` - Получение профиля пользователя (требует авторизации)
- `PUT /api/users/me` - Обновление профиля пользователя (требует авторизации)
- `GET /api/users/by-plate?plate=XXX` - Получение публичной информации о пользователе по номеру (требует авторизации)

#### Блокировки
- `POST /api/blocks` - Создание блокировки автомобиля (требует авторизации)
- `GET /api/blocks` - Получение списка созданных блокировок (требует авторизации)
- `GET /api/blocks/my` - Получение списка тех, кто перекрыл пользователя (требует авторизации)
- `GET /api/blocks/check?plate=XXX` - Проверка, заблокирована ли машина (требует авторизации)
- `DELETE /api/blocks/{id}` - Удаление блокировки (требует авторизации)
- `POST /api/blocks/{id}/warn-owner` - Предупредить владельца (звонок) (требует авторизации)

#### Приложение
- `GET /api/app/download` - Скачать релиз приложения (APK файл)

#### Другие
- `GET /health` - Проверка здоровья сервера
- `GET /server-info` - Информация о сервере (версия, URL, минимальная версия клиента)

## Особенности

- **JWT токены**: Время жизни токена составляет 3 минуты по умолчанию. Токен автоматически обновляется на клиенте, если он истекает в ближайшие 30 секунд.
- **Логирование**: Все API запросы логируются на сервере с указанием метода, пути, статуса ответа и времени выполнения.
- **Автоматическое обновление токена**: Клиент автоматически обновляет токен перед истечением, если пользователь активен в приложении.
- **Уведомление владельца**: При создании блокировки можно включить функцию "Предупредить владельца", которая автоматически позвонит владельцу заблокированного автомобиля через API телефонии.
- **Автозамена номера телефона**: При вводе номера телефона автоматически заменяются 8 или 7 на +7.
- **Портретная ориентация**: Приложение зафиксировано в портретном режиме.
- **Автоматическое версионирование**: При сборке релиза версия автоматически обновляется на основе git тегов. Для создания нового релиза создайте тег: `git tag v1.0.0 && git push origin v1.0.0`

